       SUBROUTINE UMAT(STRESS,STATEV,DDSDDE,SSE,SPD,SCD,
     1 RPL,DDSDDT,DRPLDE,DRPLDT,
     2 STRAN,DSTRAN,TIME,DTIME,TEMP,DTEMP,PREDEF,DPRED,CMNAME,
     3 NDI,NSHR,NTENS,NSTATV,PROPS,NPROPS,COORDS,DROT,PNEWDT,
     4 CELENT,DFGRD0,DFGRD1,NOEL,NPT,LAYER,KSPT,KSTEP,KINC)
C
      INCLUDE 'ABA_PARAM.INC'
C
      CHARACTER*80 CMNAME
      DIMENSION STRESS(NTENS),STATEV(NSTATV),
     1 DDSDDE(NTENS,NTENS),DDSDDT(NTENS),DRPLDE(NTENS),
     2 STRAN(NTENS),DSTRAN(NTENS),TIME(2),PREDEF(1),DPRED(1),
     3 PROPS(NPROPS),COORDS(3),DROT(3,3),DFGRD0(3,3),DFGRD1(3,3)


C LOCAL VARIABLES --------------------------------------------------------
      real(kind=8) doubkg,l1g,l2g,ng,doubmtg,doubmlg
      real(kind=8) doubki(28),l1i(16),l2i(16),ni(59),doubmti(39)
      real(kind=8) doubmli(48),tdoubki(28),tl1i(16),tl2i(16),tni(59)
      real(kind=8) tdoubmti(39),tdoubmli(48)
      real(kind=8) Tref,b1,b2,b3,b4,b5,b6,b7,b8,b9,DelTr,DelTrp,DeltXi
      real(kind=8) aT, aTm, aTp, Theta, Thetap, Tinit
      real(kind=8) eps(6),epsp(6),deps(6)
      real(kind=8) Lg(6,6),dsigg(6)
      real(kind=8) fac1,fac2,fac3,fac4,fac5,fac6,fac1p,fac2p,fac3p
      real(kind=8) fac4p,fac5p,fac6p,qk(28),ql1(16),ql2(16),qn(59)
      real(kind=8) qmt1(39),qmt2(39),qml1(48),qml2(48)
      real(kind=8) qkp(28),ql1p(16),ql2p(16),qnp(59),qmt1p(39)
      real(kind=8) qmt2p(39),qml1p(48),qml2p(48)
      real(kind=8) svk,svl1,svl2,svn,svmt1,svmt2,svml1,svml2
      real(kind=8) ktot,l1tot,l2tot,ntot,mttot,mltot 
      real(kind=8) LVISC(6,6),scal
C
      integer i,ThMode
      Integer Nk,Nl1,Nl2,Nn,Nmt,Nmll

C MECHANICAL PROPERTIES --------------------------------------------------

      doubkg = 12.133153056614171d0

      doubki = (/ 0.043235501274466515d0,0.0009881183505058289d0, 
     $ 0.11525247583631426d0,0.0008657649159431458d0,0.2505025044083595d0, 
     $ 0.4424967940431088d0,0.6714496653148672d0,0.9108691982983146d0, 
     $ 1.1223690435544995d0,1.2620875809552672d0,1.2954688021418406d0, 
     $ 1.2160873487555364d0,1.053506627693423d0,0.8617120615490421d0, 
     $ 0.7019739865063457d0,0.6350240558385849d0,0.0054551344364881516d0, 
     $ 0.6468498194590211d0,0.004123284947127104d0,0.43637314869556576d0, 
     $ 0.0012307545403018594d0,0.23106213146820664d0,0.003577255178242922d0, 
     $ 0.1316906230058521d0,0.0016663498245179653d0,0.078343091532588d0, 
     $ 0.0022210925817489624d0,0.001009221188724041d0 /)

      tdoubki = (/ 1.4217398342725012d-11,1.433243997629095d-11,
     $ 7.274784480613257d-11,3.688248136371943d-10,3.722375076200348d-10,
     $ 1.904671711559685d-09,9.745859174725584d-09,4.986779111440932d-08,
     $ 2.551644289176164d-07,1.305630033531605d-06,6.680671720940046d-06, 
     $ 3.418378368812826d-05,0.0001749122118325432d0,0.0008949940160889086d0,
     $ 0.004579521809499646d0,0.023432581253816503d0,0.025021891216012174d0,
     $ 0.12003838164469598d0,0.14038481423248284d0,0.6135078607745309d0,
     $ 1.139777636980701d0,3.1319883044961405d0,3.80908033011636d0,
     $ 16.007375460540278d0,22.09632920332014d0,81.81258811435092d0,
     $ 92.64460449793205d0,129.81358136943348d0 /)

      l1g = 4.150189489813719d0

      l1i = (/ 0.09452676069019643d0, 0.16542942516448528d0,
     $ 0.2778807565845043d0,0.38322008295018867d0,0.47972878175856876d0,
     $ 0.5400102275560018d0,0.553729039533627d0,0.5106928547062388d0,
     $ 0.4317861583450675d0,0.3172336733061556d0,0.22295914995472899d0,
     $ 0.06256945307649886d0,0.03067447789049993d0,0.03856684115908138d0,
     $ 0.03081714550171455d0,0.007296654570382088d0 /)

      tl1i = (/ 3.7095406252292727d-10, 1.904671711559685d-09,
     $ 9.745859174725584d-09,4.986779111440932d-08,2.5545836699465156d-07,
     $ 1.305630033531605d-06,6.680671720940046d-06,3.418378368812826d-05,
     $ 0.0001749122118325432d0,0.0008949940160889086d0,0.004579521809499646d0,
     $ 0.023432581253816503d0,4.806402442008544d0,22.741553665118737d0,
     $ 107.60194747391007d0,142.66588396265624d0 /)

      l2g = 4.150189489813719d0

      l2i = (/ 0.09452676069019643d0, 0.16542942516448528d0,
     $ 0.2778807565845043d0,0.38322008295018867d0,0.47972878175856876d0,
     $ 0.5400102275560018d0,0.553729039533627d0,0.5106928547062388d0,
     $ 0.4317861583450675d0,0.3172336733061556d0,0.22295914995472899d0,
     $ 0.06256945307649886d0,0.03067447789049993d0,0.03856684115908138d0,
     $ 0.03081714550171455d0,0.007296654570382088d0 /)

      tl2i = (/ 3.7095406252292727d-10, 1.904671711559685d-09,
     $ 9.745859174725584d-09,4.986779111440932d-08,2.5545836699465156d-07,
     $ 1.305630033531605d-06,6.680671720940046d-06,3.418378368812826d-05,
     $ 0.0001749122118325432d0,0.0008949940160889086d0,0.004579521809499646d0,
     $ 0.023432581253816503d0,4.806402442008544d0,22.741553665118737d0,
     $ 107.60194747391007d0,142.66588396265624d0 /)

      ng = 17.105959964009347d0

      ni = (/ 0.030794158577919006d0, 0.03237508237361908d0,
     $ 0.05926358699798584d0,
     $ 0.032573580741882324d0, 0.05487775802612305d0, 0.052622437477111816d0,
     $ 0.03831911087036133d0, 0.18582534790039062d0, 0.03629493713378906d0,
     $ 0.3146056942641735d0, 0.3914099931716919d0, 0.021368741989135742d0,
     $ 0.4916045814752579d0, 0.00989726185798645d0, 0.554734606295824d0,
     $ 0.009017929434776306d0, 0.5604971516877413d0, 0.02210380882024765d0,
     $ 0.003614187240600586d0, 0.5634492514654994d0, 0.005551436450332403d0,
     $ 0.5050862450152636d0, 0.02132873609662056d0, 0.4446977339684963d0,
     $ 0.04819868505001068d0, 0.4338412322103977d0, 0.09165469370782375d0,
     $ 0.39589832350611687d0, 0.37145502120256424d0, 0.42467644810676575d0,
     $ 0.07445186376571655d0, 1.003985047340393d0, 0.550144761800766d0,
     $ 1.6192010045051575d0, 0.6067461967468262d0, 0.3766441345214844d0,
     $ 0.4209928512573242d0, 1.0027799606323242d0, 0.3979759216308594d0,
     $ 0.39191627502441406d0, 0.2683372497558594d0, 0.2668895721435547d0,
     $ 0.26494908332824707d0, 0.7854938507080078d0, 0.743560791015625d0,
     $ 0.33807373046875d0, 0.3195343017578125d0, 0.13945770263671875d0,
     $ 0.13640594482421875d0, 0.11620187759399414d0, 0.103851318359375d0,
     $ 0.107452392578125d0, 0.1082305908203125d0, 0.124481201171875d0,
     $ 0.14400672912597656d0, 0.14601898193359375d0, 0.1540679931640625d0,
     $ 0.014653205871582031d0, 0.00016652047634124756d0 /)

      tni = (/ 1.4266588396265581d-11, 1.439859551339916d-11,
     $ 7.291554590806471d-11,
     $ 7.359022514757151d-11, 3.722375076200348d-10, 3.7266630867845083d-10,
     $ 3.7654781481333873d-10, 1.9090624333150685d-09, 1.9112615883578386d-09,
     $ 9.768325700397038d-09, 4.992523659255988d-08, 5.132395690497182d-08,
     $ 2.55752643675283d-07, 2.671899579667409d-07, 1.3086398216005497d-06,
     $ 1.4649409921133485d-06, 6.6960722597770955d-06, 7.1667149586301d-06,
     $ 7.183235942846178d-06, 3.434156886455474d-05, 4.6539330528768536d-05,
     $ 0.00017612464536310307d0, 0.00019200835710168497d0, 0.0009022359580504827d0,
     $ 0.0009745859174725594d0, 0.004627219821325456d0, 0.005257994550300976d0,
     $ 0.023540741134565574d0, 0.028237102586531324d0, 0.11990026187400234d0,
     $ 0.1392579929526541d0, 0.17571956991949253d0, 0.6734729106796986d0,
     $ 0.9723444320629345d0, 3.522249625642594d0, 4.398657343453338d0,
     $ 4.4393576187426875d0, 4.856463529182082d0, 18.742181170037984d0,
     $ 18.785386359734044d0, 20.29177937004096d0, 20.36198586560254d0,
     $ 20.62149426082468d0, 24.200265556309716d0, 93.28678621721811d0,
     $ 100.07374020937394d0, 100.53565960655507d0, 107.84999558048305d0,
     $ 108.09861549699647d0, 110.23515869346078d0, 116.4984458381956d0,
     $ 117.98318926768654d0, 118.25516860813855d0, 122.4109114540597d0,
     $ 127.15110292139738d0, 127.73800574614926d0, 130.71340612795316d0,
     $ 171.52211832155638d0, 1971.6060023167493d0 /)

      doubmtg = 3.552819444116353d0

      doubmti = (/ 0.0677494928240776d0, 0.008737973868846893d0,
     $ 0.07374674081802368d0,
     $ 0.0007799267768859863d0, 0.0009355992078781128d0, 0.07049831002950668d0,
     $ 0.06609559059143066d0, 0.0026268959045410156d0, 0.06487258523702621d0,
     $ 0.0027365684509277344d0, 0.060775354504585266d0, 0.008094601333141327d0,
     $ 0.0683624092489481d0, 0.0045916251838207245d0, 0.06417396245524287d0,
     $ 0.016354783438146114d0, 0.07059968030080199d0, 0.0213306937366724d0,
     $ 0.10676199058070779d0, 0.0010085499379783869d0, 0.11225646361708641d0,
     $ 0.02026566630229354d0, 0.16766076674684882d0, 0.007928199134767056d0,
     $ 0.2571327730547637d0, 0.00981446960940957d0, 0.4756026400718838d0,
     $ 0.0011184483300894499d0, 0.7375023631611839d0, 0.0009696392226032913d0,
     $ 0.504098052973859d0, 0.005395296262577176d0, 0.2479303115105722d0,
     $ 0.0004059100756421685d0, 0.1328124767751433d0, 0.001776936638634652d0,
     $ 0.08363402995746583d0, 0.0007714163402852137d0, 2.177844180550892d-06 /)


      tdoubmti = (/ 1.4217398342725012d-11, 1.4283022871779455d-11,
     $ 7.274784480613257d-11,
     $ 7.325210877601114d-11, 3.64602910907318d-10, 3.722375076200348d-10,
     $ 1.904671711559685d-09, 1.9112615883578386d-09, 9.757085971176137d-09,
     $ 9.984357699385393d-09, 4.998274824534704d-08, 5.1679717578401255d-08,
     $ 2.5752543630921305d-07, 2.693519547326697d-07, 1.3026271677831237d-06,
     $ 1.4515103323688108d-06, 6.665306602359406d-06, 7.582634659223125d-06,
     $ 3.510105191188036d-05, 4.273858424309152d-05, 0.0001767340100672759d0,
     $ 0.00019002910881841102d0, 0.0009022359580504827d0, 0.0009723444320629345d0,
     $ 0.004568989201614572d0, 0.005380468976773386d0, 0.023432581253816503d0,
     $ 0.02647403457080027d0, 0.11990026187400231d0, 0.16994959408867488d0,
     $ 0.6120968318503869d0, 0.7224705216500593d0, 3.1319883044961405d0,
     $ 4.627219821325455d0, 15.988956893097724d0, 19.068658086862126d0,
     $ 81.81258811435092d0, 126.71269610774857d0, 1999.033773935729d0 /)

      doubmlg = 4.041540768769933d0

      doubmli = (/ 0.07567226886749268d0, 0.006255626678466797d0,
     $ 0.07600021362304688d0,
     $ 0.0030465126037597656d0, 0.0070648193359375d0, 0.046173095703125d0,
     $ 0.021026611328125d0, 0.06931365467607975d0, 0.06542273610830307d0,
     $ 0.06340377847664058d0, 0.06215598061680794d0, 0.001662708818912506d0,
     $ 0.0656592408195138d0, 0.0016644825227558613d0, 0.07143070548772812d0,
     $ 0.0026388168334960938d0, 0.0009267330169677734d0, 0.06002497673034668d0,
     $ 0.029185593128204346d0, 0.11523761879652739d0, 0.1656268051592633d0,
     $ 0.27125624869950116d0, 0.002684850012883544d0, 0.5127743599005044d0,
     $ 0.010061288252472878d0, 0.8169105630367994d0, 0.032802543602883816d0,
     $ 0.2882080078125d0, 0.2847404479980469d0, 0.0003522932529449463d0,
     $ 0.055040016770362854d0, 0.2833903729915619d0, 0.031245708465576172d0,
     $ 0.032860517501831055d0, 0.15822529792785645d0, 0.006449699401855469d0,
     $ 0.02724170684814453d0, 0.02998054027557373d0, 0.0909271240234375d0,
     $ 0.01621246337890625d0, 0.01564788818359375d0, 0.02532958984375d0,
     $ 0.01174163818359375d0, 0.00861358642578125d0, 0.00421905517578125d0,
     $ 0.0030670166015625d0, 0.0012705326080322266d0, 5.375593900680542d-06 /)


      tdoubmli = (/ 1.4217398342725012d-11, 1.433243997629095d-11,
     $ 7.274784480613257d-11,
     $ 7.333649194839832d-11, 3.625101171621722d-10, 3.722375076200348d-10,
     $ 3.756817788715115d-10, 1.904671711559685d-09, 9.745859174725584d-09,
     $ 4.986779111440932d-08, 2.5487082905456946d-07, 2.6749774891856304d-07,
     $ 1.3026271677831237d-06, 1.4683180298702483d-06, 6.665306602359406d-06,
     $ 7.158468720942191d-06, 7.174970695617167d-06, 3.414445079893272d-05,
     $ 3.434156886455474d-05, 0.0001749122118325432d0, 0.0008949940160889086d0,
     $ 0.004579521809499646d0, 0.005300540188241605d0, 0.023486598932386273d0, 
     $ 0.028172159052746292d0, 0.12045369633713736d0, 0.1739082286718997d0,
     $ 0.6142145945524595d0, 0.6156305054238242d0, 0.7600114437370378d0,
     $ 0.9634299247265711d0, 3.142824511562494d0, 4.3233473724467375d0,
     $ 4.767823080126083d0, 16.025815245353602d0, 20.31515459766559d0,
     $ 22.020142830911333d0, 22.09632920332016d0, 82.00118560772371d0,
     $ 90.32752937590944d0, 90.74446230787417d0, 114.63576450869624d0,
     $ 116.63264686806701d0, 117.03617823194362d0, 117.5763926856471d0,
     $ 117.71183546235928d0, 168.7796693120865d0, 1994.436123839117d0 /)

C TTS COEFFICIENTS -------------------------------------------------------

      Tref = 214.92814566484793d0
      b1 = -1.38048569226571d0
      b2 = -0.0839363492674589d0
      b3 = -0.000178506624359254d0
      b4 = 1.11572814246203d-06
      b5 = 1.12274107192737d-08
      b6 = 11289.1761172407d0
      b7 = -1057.29768217945d0
      b8 = 7240.74915864856d0
      b9 = 8.68153060395207d0

C PRONY SERIES LENGTHS ---------------------------------------------------

      Nk = 28
      Nl1 = 16
      Nl2 = 16
      Nn = 59
      Nmt = 39
      Nmll = 48

C TEMPERATURE VARIABLES --------------------------------------------------

      Tinit = 230d0
      Theta = temp - Tinit
      Thetap = temp + dtemp - Tinit

C SHIFT FACTOR VALUES COMPUTATION ----------------------------------------

      DelTr = temp - Tref
      DelTrm = temp + (0.5d0*dtemp) - Tref
      DelTrp = temp + dtemp - Tref
      aT = 10**(b1 + b2*DelTr + b3*DelTr**2.0d0 + b4*DelTr**3.0d0 + 
     $       b5*DelTr**4.0d0 +(b6 + b7*DelTr)/(b8 + b9*DelTr**2.0d0))
      aTm = 10**(b1 + b2*DelTrm + b3*DelTrm**2.0d0 + b4*DelTrm**3.0d0 + 
     $      b5*DelTrm**4.0d0 +(b6 + b7*DelTrm)/(b8 + b9*DelTrm**2.0d0))
      aTp = 10**(b1 + b2*DelTrp + b3*DelTrp**2.0d0 + b4*DelTrp**3.0d0 + 
     $       b5*DelTrp**4.0d0 +(b6 + b7*DelTrp)/(b8 + b9*DelTrp**2.0d0))

C MODE SELECTOR AND INTERNAL TIME COMPUTATION ----------------------------

      ThMode = 1
      if (ThMode.EQ.0) DeltXi = dtime
      if (ThMode.EQ.1) DeltXi = dtime*((1.0d0/6.0d0)*(1/aT) + 
     $      (2.0d0/3.0d0)*(1/aTm) + (1.0d0/6.0d0)*(1/aTp))
C LOCAL STORAGE OF STRAIN VARIABLES --------------------------------------

      eps = STRAN 
      epsp = STRAN + DSTRAN
      deps = DSTRAN

C COMPUTATION OF INSTANTANEOUS PART OF THE STRESS -----------------------

      Lg = reshape((/ 0.5d0*(doubkg+doubmtg),0.5d0*(doubkg-doubmtg),l1g,
     $     0.0d0,0.0d0,0.0d0,0.5d0*(doubkg-doubmtg),
     $     0.5d0*(doubkg+doubmtg),l1g,0.0d0,0.0d0,0.0d0,l2g, l2g,ng,0.0d0,
     $     0.0d0,00d0,0.0d0, 0.0d0, 0.0d0, 0.5d0*doubmtg, 0.0d0, 0.0d0,
     $     0.0d0, 0.0d0, 0.0d0, 0.0d0, 0.5d0*doubmlg, 0.0d0,
     $     0.0d0, 0.0d0, 0.0d0, 0.0d0, 0.0d0, 0.5d0*doubmlg /),shape(Lg))

      dsigg = matmul(Lg,deps)
      STRESS = STRESS + dsigg

C INTERNAL VARIABLES HANDLER ---------------------------------------------

C SCALAR PROJECTIONS FOR INTERNAL VARIABLES UPDATE

      fac1 = eps(1)+eps(2)
      fac2 = eps(3)
      fac3 = eps(1)-eps(2)
      fac4 = 0.5d0*eps(4)
      fac5 = 0.5d0*eps(5)
      fac6 = 0.5d0*eps(6)

      fac1p = epsp(1)+epsp(2)
      fac2p = epsp(3)
      fac3p = epsp(1)-epsp(2)
      fac4p = 0.5d0*epsp(4)
      fac5p = 0.5d0*epsp(5)
      fac6p = 0.5d0*epsp(6)

C LOCAL STORAGE OF INTERNAL VARIABLES STATEV

      do i=1,Nk
        qk(i)=statev(i)
      enddo

      do i=1,Nl1
        ql1(i)=statev(i+Nk)
      enddo

      do i=1,Nl2
        ql2(i)=statev(i+Nk+Nl1)
      enddo

      do i=1,Nn
        qn(i)=statev(i+Nk+Nl1+Nl2)
      enddo

      do i=1,Nmt
        qmt1(i)=statev(i+Nk+Nl1+Nl2+Nn)
      enddo

      do i=1,Nmt
        qmt2(i)=statev(i+Nk+Nl1+Nl2+Nn+Nmt)
      enddo

      do i=1,Nmll
        qml1(i)=statev(i+Nk+Nl1+Nl2+Nn+Nmt+Nmt)
      enddo

      do i=1,Nmll
        qml2(i)=statev(i+Nk+Nl1+Nl2+Nn+Nmt+Nmt+Nmll)
      enddo

C UPDATING LOCAL AND GLOBAL INTERNAL VARIABLES
C COMPUTING THE DISSIPATIVE PART OF THE STRESS
C COMPUTING CONTRIBUTIONS FOR DDSDDE MATRIX

      svk=0.0d0
      ktot=0.0d0
      do i=1,Nk
        scal=DeltXi/tdoubki(i)
        qkp(i)=qk(i)*exp(-scal)+fac1*(1.0d0-exp(-scal))+
     $   (fac1p-fac1)*(1.0d0-(1.0d0/scal)*(1.0d0-exp(-scal)))
        STATEV(i)=qkp(i) 
        svk=svk+0.5d0*doubki(i)*(qkp(i)-qk(i))
        ktot=ktot+0.5d0*doubki(i)*(1.0d0-(1.0d0/scal)*(1.0d0-exp(-scal)))
      enddo

      svl1=0.0d0
      l1tot=0.0d0
      do i=1,Nl1
        scal=DeltXi/tl1i(i)
        ql1p(i)=ql1(i)*exp(-scal)+fac2*(1.0d0-exp(-scal))+
     $   (fac2p-fac2)*(1.0d0-(1.0d0/scal)*(1.0d0-exp(-scal)))
        STATEV(i+Nk)=ql1p(i)
        svl1=svl1+l1i(i)*(ql1p(i)-ql1(i))
        l1tot=l1tot+l1i(i)*(1.0d0-(1.0d0/scal)*(1.0d0-exp(-scal)))
      enddo

      svl2=0.0d0
      l2tot=0.0d0
      do i=1,Nl2
        scal=DeltXi/tl2i(i)
        ql2p(i)=ql2(i)*exp(-scal)+fac1*(1.0d0-exp(-scal))+
     $   (fac1p-fac1)*(1.0d0-(1.0d0/scal)*(1.0d0-exp(-scal)))
        STATEV(i+Nk+Nl1)=ql2p(i)
        svl2 = svl2 + l2i(i)*(ql2p(i)-ql2(i))
        l2tot=l2tot+l2i(i)*(1.0d0-(1.0d0/scal)*(1.0d0-exp(-scal)))
      enddo

      svn=0.0d0
      ntot=0.0d0
      do i=1,Nn
        scal=DeltXi/tni(i)
        qnp(i)=qn(i)*exp(-scal)+fac2*(1.0d0-exp(-scal))+
     $   (fac2p-fac2)*(1.0d0-(1.0d0/scal)*(1.0d0-exp(-scal)))
        STATEV(i+Nk+Nl1+Nl2)=qnp(i)
        svn=svn+ni(i)*(qnp(i)-qn(i))
        ntot=ntot+ni(i)*(1.0d0-(1.0d0/scal)*(1.0d0-exp(-scal)))
      enddo

      svmt1=0.0d0
      mttot=0.0d0
      do i=1,Nmt
        scal=DeltXi/tdoubmti(i)
        qmt1p(i)=qmt1(i)*exp(-scal)+fac3*(1.0d0-exp(-scal))+
     $     (fac3p-fac3)*(1.0d0-(1.0d0/scal)*(1.0d0-exp(-scal)))
        STATEV(i+Nk+Nl1+Nl2+Nn)=qmt1p(i)
        svmt1=svmt1+0.5d0*doubmti(i)*(qmt1p(i)-qmt1(i))
        mttot=mttot+0.5d0*doubmti(i)*(1.0d0-(1.0d0/scal)*(1.0d0-exp(-scal)))
      enddo

      svmt2 = 0.0d0
      do i=1,Nmt
        scal = DeltXi/tdoubmti(i)
        qmt2p(i)= qmt2(i)*exp(-scal)+fac4*(1.0d0-exp(-scal))+
     $   (fac4p-fac4)*(1.0d0-(1.0d0/scal)*(1.0d0-exp(-scal)))
        STATEV(i+Nk+Nl1+Nl2+Nn+Nmt)=qmt2p(i)
        svmt2 = svmt2 + doubmti(i)*(qmt2p(i)-qmt2(i))
      enddo

      svml1=0.0d0
      mltot=0.0d0
      do i=1,Nmll
        scal=DeltXi/tdoubmli(i)
        qml1p(i)=qml1(i)*exp(-scal)+fac5*(1.0d0-exp(-scal))+
     $   (fac5p-fac5)*(1.0d0-(1.0d0/scal)*(1.0d0-exp(-scal)))
        STATEV(i+Nk+Nl1+Nl2+Nn+Nmt+Nmt)=qml1p(i)
        svml1=svml1 + doubmli(i)*(qml1p(i)-qml1(i))
        mltot=mltot+
     $   0.5d0*doubmli(i)*(1.0d0-(1.0d0/scal)*(1.0d0-exp(-scal)))
      enddo

      svml2=0.0d0
      do i=1,Nmll
        scal=DeltXi/tdoubmli(i)
        qml2p(i)=qml2(i)*exp(-scal)+fac6*(1.0d0-exp(-scal))+
     $   (fac6p-fac6)*(1.0d0-(1.0d0/scal)*(1.0d0-exp(-scal)))
        STATEV(i+Nk+Nl1+Nl2+Nn+Nmt+Nmt+Nmll)=qml2p(i)
        svml2=svml2 + doubmli(i)*(qml2p(i)-qml2(i))
      enddo

C UPDATING STRESS ELEMENTS -----------------------------------------------

      STRESS(1)=STRESS(1)-svk-svmt1-svl1
      STRESS(2)=STRESS(2)-svk+svmt2-svl1
      STRESS(3)=STRESS(3)-svl2-svn
      STRESS(4)=STRESS(4)-svmt2
      STRESS(5)=STRESS(5)-svml1
      STRESS(6)=STRESS(6)-svml2

C UPDATING DDSDDE --------------------------------------------------------
        
      LVISC = reshape((/ktot+mttot,ktot-mttot,l1tot,0.0d0,0.0d0,0.0d0,
     $                ktot-mttot,ktot+mttot,l1tot,0.0d0,0.0d0,0.0d0,
     $                          l2tot, l2tot,ntot,0.0d0,0.0d0,0.0d0,
     $                          0.0d0,0.0d0,0.0d0,mttot,0.0d0,0.0d0,
     $                          0.0d0,0.0d0,0.0d0,0.0d0,mltot,0.0d0,
     $                0.0d0,0.0d0,0.0d0,0.0d0,0.0d0,mltot /),shape(LVISC))
     
      DDSDDE = Lg-LVISC

      RETURN
      END

      SUBROUTINE UEXPAN(EXPAN,DEXPANDT,TEMP,TIME,DTIME,PREDEF,DPRED,
     1     STATEV,CMNAME,NSTATV,NOEL)
C
      INCLUDE 'ABA_PARAM.INC'
C
      CHARACTER*80 CMNAME
C
      DIMENSION EXPAN(*),DEXPANDT(*),TEMP(2),TIME(2),PREDEF(*),
     1     DPRED(*),STATEV(NSTATV)

C LOCAL VARIABLES --------------------------------------------------------

      real(kind=8) altg,allg,alti(133),alli(135),talti(133),talli(135) 
      real(kind=8) Tref,b1,b2,b3,b4,b5,b6,b7,b8,b9,DelTr,DelTrp,DeltXi
      real(kind=8) aT,aTm,aTp,Theta,Thetap,Tinit
      real(kind=8) exptg,explg,exptgp,explgp
      real(kind=8) exptv,explv,alttot,alltot
      real(kind=8) expt,expl,expp(3),exptp,explp,exppp(3)
      real(kind=8) qalt(133),qall(135),qaltp(133),qallp(135)

      integer NmecSttv, Nalt, Nall, ThMode

C THERMOMECHANICAL PROPERTIES --------------------------------------------


      altg = 5.780519431405963d-05

      alti = (/ -6.088691089575771d-07, -6.189063379014037d-07,
     $ -6.375878695702442d-07,
     $ -6.660310815642667d-07, -1.4527564928812353d-08, -6.857604990528898d-07,
     $ -7.435206935690886d-07, -7.9359266846879d-07, -8.487655467348532d-07,
     $ -1.223272647621343d-07, -4.047433321829885d-08, -9.020041034091264d-07,
     $ -2.0614243112504482d-07, 2.0542938727885485d-07, -1.1050578905269504d-06,
     $ 8.41217115521431d-07, -1.760898157954216d-06, -1.7436104826629162d-07,
     $ -1.300446456298232d-06, 8.12142388895154d-08, 1.0260555427521467d-07,
     $ 6.433401722460985d-08, -1.0517833288758993d-06, 2.2193999029695988d-06,
     $ -1.9319995772093534d-06, -2.007000148296356d-06, 1.8423452274873853d-06,
     $ -1.3185517673264258d-06, 3.509640009724535d-07, 2.967876753245946d-07,
     $ -2.1479372662724927d-06, 6.665322871413082d-07, 5.879301170352846d-07,
     $ -3.677996573969722d-09, 3.001769073307514d-07, 9.596988093107939d-08,
     $ -1.8488935893401504d-06, 2.7690111892297864d-07, 2.6789348339661956d-07,
     $ 8.441420504823327d-07, 2.147135091945529d-07, 1.64181983564049d-07,
     $ -1.8087448552250862d-06, 3.5937409847974777d-07, -3.734021447598934d-08,
     $ 1.5902332961559296d-07, 1.1432566680014133d-06, 1.139589585363865d-06,
     $ -2.416782081127167d-07, -3.024761099368334d-07, -1.5223922673612833d-06,
     $ 5.930196493864059d-07, -2.945307642221451d-07, -3.291643224656582d-07,
     $ 7.17060174793005d-07, 1.4986144378781319d-06, 1.0917428880929947d-06,
     $ -1.5774276107549667d-07, -1.827138476073742d-07, -1.2960517778992653d-06,
     $ 2.0059815142303705d-08, 1.0084477253258228d-08, 3.506997018121183d-06,
     $ 4.045286914333701d-07, 3.608874976634979d-08, -1.239714038092643d-06,
     $ -1.2967211659997702d-07, 4.374393029138446d-06, -2.544670678616967d-07,
     $ 6.981736078159884d-09, 4.774659601025633d-06, -3.8111102185212076d-07,
     $ -6.269983714446425d-07, 6.051850505173206d-07, 4.263246410118882d-06,
     $ -4.7370485845021904d-07, -1.6648846212774515d-07, -3.73147486243397d-08,
     $ 6.72000169288367d-07, -2.435990609228611d-08, -4.7541107051074505d-07,
     $ -1.8961145542562008d-08, -2.812157617881894d-08, -1.7022830434143543d-06,
     $ -3.3032847568392754d-08, -2.0037987269461155d-08, -5.777692422270775d-07,
     $ -1.605367287993431d-07, 2.1685264073312283d-07, -1.9441358745098114d-07,
     $ -5.953479558229446d-07, -3.4854747354984283d-07, 4.912726581096649d-08,
     $ 5.3085386753082275d-08, -5.036708898842335d-07, -2.0864536054432392d-07,
     $ -1.751177478581667d-07, 1.9883736968040466d-07, 1.9776052795350552d-07,
     $ 1.8958235159516335d-07, -1.5244586393237114d-07, -1.519802026450634d-07,
     $ 2.7030182536691427d-08, 5.311449058353901d-08, 1.9959406927227974d-07,
     $ 1.5328987501561642d-07, 1.2590317055583d-07, -1.5954719856381416d-07,
     $ -3.775348886847496d-07, -4.193279892206192d-07, 2.6222551241517067d-07,
     $ 4.0490704122930765d-08, -5.652200343320146d-07, -1.7627371562412009d-07,
     $ -4.6755303628742695d-08, -8.770439308136702d-08, -7.880735211074352d-07,
     $ -3.547145752236247d-06, -3.798952093347907d-06, 1.750304363667965d-07,
     $ 1.6413105186074972d-07, -2.56011844612658d-07, -6.401662631105864d-07,
     $ -5.346263485250802d-07, -4.751019213600216d-07, -4.237533293149909d-07,
     $ -2.18506102100946d-07, -1.5786554286023602d-07, -3.341786039001704d-07,
     $ -2.966934440351565d-07, -2.6273581005265d-07, -2.337408243346939d-07,
     $ -2.086406042430683d-07 /)


      talti = (/ 1.0935033847070227d-16, 4.96386694266375d-16,
     $ 2.2481233252960005d-15,
     $ 1.0205167367138971d-14, 4.459848762481597d-14, 4.632550172824962d-14, 
     $ 2.0980707620545198d-13, 9.524016335735564d-13, 4.323347372446729d-12, 
     $ 1.4315948639971032d-11, 1.674249321631786d-11, 1.9580335620638038d-11, 
     $ 7.342097232644826d-11, 8.078302870502852d-11, 8.888329206185992d-11, 
     $ 3.7395567788896193d-10, 3.884365888832151d-10, 4.034782529175287d-10, 
     $ 1.8273432429008998d-09, 1.906865808686213d-09, 1.9090624333150763d-09, 
     $ 1.992141265675309d-09, 7.325210877601144d-09, 8.295071458572595d-09, 
     $ 9.339424844723895d-09, 9.371737845814222d-09, 1.0551644034962706d-08, 
     $ 3.554840600162313d-08, 4.288645329736501d-08, 9.723444320629345d-08, 
     $ 1.7171970417567542d-07, 2.212178319211916d-07, 2.2403719762232213d-07, 
     $ 2.886158193995422d-07, 4.7024060950473644d-07, 4.7568573913364417d-07, 
     $ 7.750328875537399d-07, 1.088479193029602d-06, 1.0935033847070228d-06, 
     $ 1.5357486125754984d-06, 2.319103501635387d-06, 2.3271272499092668d-06, 
     $ 3.5141486763025783d-06, 4.745916922931149d-06, 5.355747967372048d-06, 
     $ 7.2330277556863966d-06, 8.162442438317629d-06, 1.0065147221642234d-05, 
     $ 1.135847775024208d-05, 1.1410906101419032d-05, 1.5878889688045857d-05,
     $ 2.31110741860257d-05, 2.608075333083268d-05, 2.62011366185104d-05, 
     $ 3.813468221297965d-05, 4.303483395625975d-05, 4.929695922985524d-05, 
     $ 5.563141822336336d-05, 5.575966188697935d-05, 7.208088855601777d-05, 
     $ 0.0001271511029213974d0, 0.0001280324722609902d0, 
     $ 0.00022585001910855338d0, 
     $ 0.0002693519547326705d0, 0.0002749920456004269d0, 
     $ 0.0003279594365799439d0, 
     $ 0.001133235397634359d0, 0.0011582975337448888d0, 
     $ 0.0018570351820241362d0, 
     $ 0.004368377199288104d0, 0.006135078607745312d0, 
     $ 0.027028387186372106d0, 
     $ 0.02909511858664794d0, 0.03081911274738182d0, 0.03317570278749234d0, 
     $ 0.1423377615348431d0, 0.16531799583178075d0, 0.16955872086888812d0, 
     $ 0.19693374131771169d0, 0.3522249625642596d0, 0.6256336964282874d0, 
     $ 0.8478521614096575d0, 0.8498066624965684d0, 1.15164899156072d0, 
     $ 1.8064258177701285d0, 1.8126757785963754d0, 2.8432832830995602d0, 
     $ 3.5589356184789764d0, 4.205524153971d0, 5.264051526242862d0, 
     $ 6.220426052782511d0, 7.565195083450034d0, 8.939642090673496d0, 
     $ 8.970571903742902d0, 12.891995096098123d0, 16.7232288002853d0, 
     $ 16.916874663256014d0, 21.91896946474353d0, 21.94421914300939d0, 
     $ 22.147266502781456d0, 28.728975016365435d0, 28.762069518241464d0, 
     $ 34.105163167342d0, 34.579613247775285d0, 37.65478148133399d0, 
     $ 44.701297756705465d0, 45.271004568298224d0, 49.98274824534714d0, 
     $ 53.74278047413011d0, 64.91127379376088d0, 92.5380048307762d0, 
     $ 176.93759978895596d0, 266.8825211684406d0, 1211.49083114884d0, 
     $ 1485.3203513361148d0, 1488.7443683678953d0, 1544.6145860707302d0, 
     $ 1825.2406468292913d0, 1893.7390367914393d0, 3157.3311303896617d0, 
     $ 3160.968235471148d0, 3275.8207659260806d0, 5467.894564677285d0, 
     $ 24821.048983624634d0, 112413.93015352837d0, 510293.61187895696d0, 
     $ 2313769.7115927306d0, 2316435.0714260507d0, 10491078.378527286d0, 
     $ 47623370.79552668d0, 216182299.2925341d0, 979084401.6758906d0, 
     $ 4444471561.337507d0 /)

      allg = 2.938437381950625d-05

      alli = (/ -1.2449297373106488d-07, -1.2654528636427131d-07, 
     $ -1.3036549226241867d-07, 
     $ -1.3618260633063706d-07, -2.986920932812609d-09, -1.4020839866901724d-07, 
     $ -1.5207730946764642d-07, -1.6252233847602326d-07, -1.7518859074527882d-07, 
     $ 1.2401801541273016d-07, -1.20776348921936d-08, -1.7085596937249647d-07, 
     $ 8.481038094032556d-08, 7.251219358295202d-08, -2.1844061848241836d-07, 
     $ 4.113899194635451d-07, -6.156042218208313d-07, 1.5116529539227486d-07, 
     $ -1.0944222594844177d-07, -2.0768766262335703d-07, -1.9452727428870276d-07, 
     $ 4.7193316277116537d-07, -5.480906111188233d-07, 2.913820935646072d-07, 
     $ 3.1747458706377074d-07, -8.57162376632914d-08, -6.066229616408236d-07, 
     $ 7.348417057073675d-07, -1.9758772396016866d-07, 2.565138856880367d-07, 
     $ -4.81042661704123d-07, -2.764118107734248d-07, 8.458737283945084d-07, 
     $ -2.0797597244381905d-07, -4.2637111619114876d-08, 8.370989235118032d-08, 
     $ -2.6565976440906525d-07, -8.707775123184547d-08, -4.288085619919002d-08, 
     $ 4.2992178350687027d-07, 2.784945536404848d-07, -2.19675712287426d-07, 
     $ 5.0640664994716644d-09, 2.5582266971468925d-08, -1.6952981241047382d-08, 
     $ -3.753521014004946d-07, -2.2107087715994567d-08, 1.6740523278713226d-07, 
     $ 5.754409357905388d-07, 9.16188582777977d-08, -2.15193722397089d-07, 
     $ -7.945345714688301d-08, 2.4365726858377457d-07, -1.4769466361030936d-07, 
     $ -4.051835276186466d-07, -1.9885192159563303d-08, 4.306202754378319d-07, 
     $ 5.113397492095828d-07, -8.702045306563377d-09, -9.262294042855501d-08, 
     $ 6.880145519971848d-08, 2.0622974261641502d-07, -2.2400854504667222d-07, 
     $ -3.9761653169989586d-07, 6.32571754977107d-08, 4.5236083678901196d-07, 
     $ 2.0102379494346678d-07, 7.404014468193054d-08, -6.999471224844456d-09, 
     $ 1.5757541405037045d-07, 3.00715328194201d-07, 3.110762918367982d-07, 
     $ -4.963367246091366d-07, -2.6091584004461765d-08, 1.2661257642321289d-07, 
     $ -3.5388802643865347d-07, 1.2910677469335496d-06, 7.574708433821797d-07, 
     $ 2.3039319785311818d-08, 4.551948222797364d-07, 1.1013398761861026d-06, 
     $ -6.417394615709782d-09, -1.2687451089732349d-08, 2.949964255094528d-07, 
     $ 9.940704330801964d-07, 3.082677721977234d-07, 6.298068910837173d-08, 
     $ -8.079223334789276d-08, -8.66129994392395d-08, 1.266016624867916d-07, 
     $ 9.06948116607964d-07, 7.136259227991104d-08, -3.710738383233547d-10, 
     $ -4.3190084397792816d-08, -1.3969838619232178d-08, 6.868503987789154d-08, 
     $ 1.3882527127861977d-08, -4.901085048913956d-08, -2.403976395726204d-08, 
     $ 1.4237593859434128d-07, 2.096639946103096d-07, 2.050073817372322d-07, 
     $ 5.273614078760147d-08, 4.7963112592697144d-08, -7.450580596923828d-09, 
     $ 2.954038791358471d-07, 7.741618901491165d-09, 8.119968697428703d-08, 
     $ 1.4310353435575962d-07, 1.1746305972337723d-07, -1.6232661437243223d-08, 
     $ 1.760781742632389d-08, 1.1015799827873707d-08, -1.1026713764294982d-08, 
     $ 5.648871592711657d-09, 6.548361852765083d-10, 6.693881005048752d-10, 
     $ 4.220055416226387d-10, -1.0040821507573128d-09, 1.3536919141188264d-08, 
     $ 2.0270817913115025d-08, 7.683411240577698d-09, -2.990418579429388d-09, 
     $ -3.914465196430683d-09, 2.0834249880863354d-09, 1.5577938938804436d-09, 
     $ 1.3658372211011738d-09, 1.2140244365355102d-09, 7.121343514882028d-10, 
     $ 3.710738383233547d-10, 9.567594494441778d-10, 8.493696856959332d-10, 
     $ 7.521642197971801d-10, 6.691499299105175d-10, 5.972955012534253d-10 /)


      talli = (/ 1.0935033847070227d-16, 4.96386694266375d-16, 
     $ 2.2481233252960005d-15, 
     $ 1.0205167367138971d-14, 4.459848762481597d-14, 4.632550172824962d-14, 
     $ 2.0980707620545198d-13, 9.524016335735564d-13, 4.323347372446729d-12, 
     $ 1.4315948639971032d-11, 1.674249321631786d-11, 1.9580335620638038d-11, 
     $ 7.308363360096303d-11, 8.059723289478588d-11, 8.888329206185992d-11, 
     $ 3.7309560369662247d-10, 3.879896420662857d-10, 4.034782529175287d-10, 
     $ 1.823140470067934d-09, 1.869907534952078d-09, 1.8720615852928246d-09, 
     $ 1.9200835710168538d-09, 8.304627012078815d-09, 9.022359580504809d-09, 
     $ 9.064004900144701d-09, 9.847367176107836d-09, 4.547996603107771d-08, 
     $ 5.368094241522083d-08, 9.712256233273336d-08, 1.6897409598688093d-07, 
     $ 2.1297083401709896d-07, 2.2223892703918097d-07, 2.801045294319799d-07, 
     $ 4.4342495604039597d-07, 4.7459169229311486d-07, 7.513116646809364d-07, 
     $ 9.85871090526275d-07, 1.0466949567824073d-06, 1.0600348210920346d-06, 
     $ 1.390977585193808d-06, 1.4767947223632758d-06, 2.1346178249315695d-06, 
     $ 2.2559014928672633d-06, 2.2663142610470516d-06, 3.4619447424763833d-06, 
     $ 4.784319028746906d-06, 5.102936118789569d-06, 5.270115479551717d-06, 
     $ 7.052127111116482d-06, 7.76819522877754d-06, 1.0551644034962706d-05, 
     $ 1.087226756146614d-05, 1.1623050684799604d-05, 1.626747438806451d-05, 
     $ 2.3868225465015858d-05, 2.513738701823413d-05, 2.6749774891856414d-05, 
     $ 3.688248136371958d-05, 4.133520840829433d-05, 5.0329212104486995d-05, 
     $ 5.3495854827483025d-05, 5.640532834134713d-05, 7.299954137499251d-05,
     $ 0.0001142405095789808d0, 0.00012184848440430904d0, 
     $ 0.00012981358136943363d0, 
     $ 0.00018252406468292914d0, 0.00019068658086862127d0, 
     $ 0.0002166806509606318d0, 
     $ 0.00023676643316243042d0, 0.000256342214408007d0, 
     $ 0.00026904203027589387d0, 
     $ 0.0003182879020530507d0, 0.0005569550314368191d0, 
     $ 0.0005634042667481626d0, 
     $ 0.000985871090526275d0, 0.0010228692707545026d0, 
     $ 0.004670034959183956d0, 
     $ 0.005374278047413008d0, 0.006184721267258431d0, 0.02389572059952653d0, 
     $ 0.028010452943198004d0, 0.028042719739592523d0, 0.032871546116115445d0, 
     $ 0.12325942335610673d0, 0.13207485167852348d0, 0.13782250260398274d0, 
     $ 0.14598899929652537d0, 0.1476794722363278d0, 0.16323757395463553d0, 
     $ 0.6394699363550949d0, 0.778610276821547d0, 0.8143669341657418d0, 
     $ 0.9317944763646984d0, 0.9915625864434761d0, 1.1866431365247503d0, 
     $ 1.5111936904315444d0, 1.835777876076771d0, 2.1004876462883426d0, 
     $ 2.67497748918564d0, 3.249526863924421d0, 3.317570278749234d0, 
     $ 4.030139987097554d0, 4.048742268070571d0, 5.021345812878549d0, 
     $ 16.286213795277853d0, 17.291000830035085d0, 19.00291088184112d0, 
     $ 85.37291918278355d0, 86.16286507801587d0, 106.00348210920367d0, 
     $ 148.36112970859463d0, 151.29345183724817d0, 184.21293905969364d0, 
     $ 262.9178859871235d0, 1246.8670021096027d0, 1530.4534744261973d0, 
     $ 1533.9815340518994d0, 1587.8889688045858d0, 1882.8691147678555d0, 
     $ 1949.0372150344188d0, 3157.3311303896617d0, 3260.7697366754473d0, 
     $ 3268.286587235697d0, 5467.894564677285d0, 24821.048983624634d0, 
     $ 112413.93015352837d0, 510293.61187895696d0, 2313769.7115927306d0, 
     $ 2316435.0714260507d0, 10491078.378527286d0, 47623370.79552668d0, 
     $ 216182299.2925341d0, 979084401.6758906d0, 4444471561.337507d0 /)

C TTS COEFFICIENTS -------------------------------------------------------

      Tref = 214.92814566484793d0
      b1 = -1.38048569226571d0
      b2 = -0.0839363492674589d0
      b3 = -0.000178506624359254d0
      b4 = 1.11572814246203d-06
      b5 = 1.12274107192737d-08
      b6 = 11289.1761172407d0
      b7 = -1057.29768217945d0
      b8 = 7240.74915864856d0
      b9 = 8.68153060395207d0

C PRONY SERIES LENGTHS ---------------------------------------------------

      NmecSttv=293
      Nalt=133
      Nall=135

C SHIFT FACTOR VALUES COMPUTATION ----------------------------------------

      DelTr = temp(1) - temp(2) - Tref
      DelTrm = temp(1) - 0.5d0*temp(2) - Tref
      DelTrp = temp(1) - Tref
      aT = 10**(b1 + b2*DelTr + b3*DelTr**2.0d0 + b4*DelTr**3.0d0 + 
     $       b5*DelTr**4.0d0 +(b6 + b7*DelTr)/(b8 + b9*DelTr**2.0d0))
      aTm = 10**(b1 + b2*DelTrm + b3*DelTrm**2.0d0 + b4*DelTrm**3.0d0 + 
     $      b5*DelTrm**4.0d0 +(b6 + b7*DelTrm)/(b8 + b9*DelTrm**2.0d0))
      aTp = 10**(b1 + b2*DelTrp + b3*DelTrp**2.0d0 + b4*DelTrp**3.0d0 + 
     $       b5*DelTrp**4.0d0 +(b6 + b7*DelTrp)/(b8 + b9*DelTrp**2.0d0))

C MODE SELECTOR AND INTERNAL TIME COMPUTATION ----------------------------

      ThMode = 1
      if (ThMode.EQ.0) DeltXi = dtime
      if (ThMode.EQ.1) DeltXi = dtime*((1.0d0/6.0d0)*(1/aT) + 
     $      (2.0d0/3.0d0)*(1/aTm) + (1.0d0/6.0d0)*(1/aTp))

C LOCAL STORAGE OF STRAIN VARIABLES --------------------------------------
      Tinit = 230.0d0
      Theta = temp(1) - temp(2) - Tinit
      Thetap = temp(1) - Tinit

C COMPUTATION OF INSTANTANEOUS PART OF THE THERMAL STRAINS ---------------

      exptg = altg*(Theta)
      explg = allg*(Theta)
      exptgp = altg*(Thetap)
      explgp = allg*(Thetap)

C INTERNAL VARIABLES HANDLER ---------------------------------------------

C UPDATING LOCAL AND GLOBAL INTERNAL VARIABLES
C COMPUTING CONTRIBUTIONS FOR DDSDDE MATRIX
C COMPUTING CONTRIBUTIONS FOR DEXPANDT MATRIX

      do i=1,Nalt
        qalt(i)=STATEV(NmecSttv+i)
      enddo

      do i=1,Nall
        qall(i)=STATEV(NmecSttv+Nalt+i)
      enddo

      exptv=0.0d0
      exptvp=0.0d0
      alttot=0.0d0

      do i=1,Nalt
        scal=DeltXi/talti(i)
        qaltp(i)=qalt(i)*exp(-scal)+Theta*(1.0d0-exp(-scal))+
     $   (Thetap-Theta)*(1.0d0-(1.0d0/scal)*(1.0d0-exp(-scal)))
        STATEV(NmecSttv+ i)=qaltp(i)
        exptv=exptv+alti(i)*(qaltp(i)-qalt(i))
        alttot=alttot+alti(i)*(1.0d0-(1.0d0/scal)*(1.0d0-exp(-scal)))
      enddo

      explv=0.0d0
      explvp=0.0d0
      alltot=0.0d0

      do i=1,Nall
        scal=DeltXi/talli(i)
        qallp(i)=qall(i)*exp(-scal)+Theta*(1.0d0-exp(-scal))+
     $   (Thetap-Theta)*(1.0d0-(1.0d0/scal)*(1.0d0-exp(-scal)))
        STATEV(NmecSttv+Nalt+i)=qallp(i)
        explv=explv+alli(i)*(qallp(i)-qall(i))
        alltot=alltot+alli(i)*(1.0d0-(1.0d0/scal)*(1.0d0-exp(-scal)))
      enddo

      EXPAN(1)=(exptgp-exptg)-exptv
      EXPAN(2)=(exptgp-exptg)-exptv
      EXPAN(3)=(explgp-explg)-explv
      DEXPANDT(1) = altg-alttot
      DEXPANDT(2) = altg-alttot
      DEXPANDT(3) = allg-alltot

      RETURN
      END